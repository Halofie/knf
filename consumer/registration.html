<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,700" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="../public/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css"> <!-- Link to the CSS file -->
    <title>Customer Details Form</title>
</head>

<body class="paleGreen">
<!-- this is the offcanvas-->
<div class="offcanvas offcanvas-start sidebar " tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">MENU</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <div class="col d-flex justify-content-center">
            <img src="../public/Assets/pic.jpeg" class=" profile rounded-circle border p-0 border-dark" alt="logo">
        </div>
        <div>
          <a class="btn" href="../home.html">HOME</a>
        </div>
    </div>
</div>
    <header class="registration-header">
        <div class="container d-flex justify-content-center align-items-center">
            <div class="logo">
                <img src="../public/Assets/pic.jpeg" alt="logo">
                Kovai Natural Farmers
            </div>
        </div>
    </header>

    <div class="registration-container">
        <h2>Create Your Account</h2>
        <div id="responseMessage" class="mb-3"></div>
        <form id="registerForm">
            <div class="mb-3">
                <label for="name" class="form-label">Full Name:</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email Address:</label>
                <input type="email" class="form-control" id="email" name="email" required>
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">Phone Number:</label>
                <input type="tel" class="form-control" id="phone" name="phone" required pattern="[0-9]{10}" title="10-digit phone number">
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="password" class="form-label">Password:</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="confirm_password" class="form-label">Confirm Password:</label>
                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="address" class="form-label">Address:</label>
                <textarea class="form-control" id="address" name="address" rows="2" required></textarea>
            </div>
            <!-- Admin assigns route post-registration, or a default is used -->
            <input type="hidden" id="routeID" name="routeID" value="1"> <!-- Placeholder default -->

            <button type="submit" class="btn btn-register w-100">Register</button>
        </form>
        <p class="text-center mt-3">
            Already have an account? <a href="../login/login.html">Login here</a>
        </p>
    </div>

    <script src="../public/js/jquery.js"></script>
    <script src="../public/js/bootstrap.bundle.min.js"></script>
    <script>
    $(document).ready(function () {
        $('#registerForm').on('submit', function (event) {
            event.preventDefault();
            $('#responseMessage').html('').removeClass('alert alert-danger alert-success');

            let password = $('#password').val();
            let confirmPassword = $('#confirm_password').val();

            if (password !== confirmPassword) {
                $('#responseMessage').html('Passwords do not match.').addClass('alert alert-danger');
                return;
            }
            if (!/^[0-9]{10}$/.test($('#phone').val())) {
                 $('#responseMessage').html('Please enter a valid 10-digit phone number.').addClass('alert alert-danger');
                return;
            }

            let customerAccountData = {
                customerName: $('#name').val(), // Will be 'username' in 'accounts'
                emailID: $('#email').val(),    // Will be 'email' in 'accounts'
                password: password             // Will be 'password' in 'accounts' (hashed server-side)
            };
            
            let customerDetailsData = {
                customerName: $('#name').val(),
                emailID: $('#email').val(),
                contact: $('#phone').val(),
                address: $('#address').val(),
                routeID: $('#routeID').val() || 1, // Default or placeholder
                alternativeContact: ''
            };

            // 1. Create account
            $.ajax({
                url: "../knft/submitCustomerAcc.php",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(customerAccountData),
                dataType: "json",
                success: function(accResponse) {
                    if (accResponse.success) {
                        // 2. Submit customer details
                        $.ajax({
                            url: "../knft/submitCustomer.php",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(customerDetailsData),
                            dataType: "json",
                            success: function(custResponse) {
                                if (custResponse.success) {
                                    $('#responseMessage').html('Registration successful! You can now <a href="../login/login.html">login</a>.').addClass('alert alert-success');
                                    $('#registerForm')[0].reset();
                                } else {
                                     $('#responseMessage').html('Account created, but error saving details: ' + (custResponse.message || 'Unknown error')).addClass('alert alert-danger');
                                     // Potentially: logic to delete the account if details fail.
                                }
                            },
                            error: function(jqXHR) {
                                $('#responseMessage').html('Error submitting customer details: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : jqXHR.responseText)).addClass('alert alert-danger');
                            }
                        });
                    } else {
                         $('#responseMessage').html('Error creating account: ' + (accResponse.message || 'This email might already be registered.')).addClass('alert alert-danger');
                    }
                },
                error: function(jqXHR) {
                     $('#responseMessage').html('Error creating account: ' + (jqXHR.responseJSON ? jqXHR.responseJSON.message : jqXHR.responseText)).addClass('alert alert-danger');
                }
            });
        });
    });
    </script>
</body>

<!-- <body>
    <h2>Customer Details Form</h2>
    <form id="registerForm">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required><br><br>

        <label for="address">Address:</label>
        <input type="text" id="address" name="address" required><br><br>

        <label for="phone">Phone Number:</label>
        <input type="text" id="phone" name="phone" required><br><br>

        <button type="submit">Submit</button>
    </form>

    <p id="responseMessage"></p>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
    let form = document.getElementById("registerForm");

    if (!form) {
        console.error("Form not found!");
        return;
    }

    form.addEventListener("submit", function (event) {
        event.preventDefault();

        let formData = {
            name: document.getElementById("name").value,
            address: document.getElementById("address").value,
            phone: document.getElementById("phone").value
        };

        fetch("http://localhost/knf/knft/submitInfo.php", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            alert(data.message);
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Failed to submit data.");
        });
    });
});

    </script>
</body> -->
</html>